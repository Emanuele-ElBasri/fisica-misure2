<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>La Fabbrica di Precisione - Laboratorio Vittoriano</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Courier+Prime:wght@400;700&family=IM+Fell+English:ital@0;1&display=swap');
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier Prime', 'Courier New', monospace;
            background: 
                radial-gradient(circle at 15% 20%, rgba(101, 67, 33, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 85% 80%, rgba(101, 67, 33, 0.12) 0%, transparent 40%),
                radial-gradient(circle at 50% 50%, rgba(139, 90, 43, 0.05) 0%, transparent 60%),
                linear-gradient(135deg, #f4e4c1 0%, #e8d4b0 25%, #d9bc8c 50%, #e8d4b0 75%, #f4e4c1 100%);
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                repeating-linear-gradient(0deg, transparent, transparent 1px, rgba(101, 67, 33, 0.03) 1px, rgba(101, 67, 33, 0.03) 2px),
                repeating-linear-gradient(90deg, transparent, transparent 1px, rgba(101, 67, 33, 0.02) 1px, rgba(101, 67, 33, 0.02) 2px);
            pointer-events: none;
            z-index: 0;
        }

        body::after {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(ellipse at 10% 15%, rgba(139, 90, 43, 0.08) 0%, transparent 30%),
                radial-gradient(ellipse at 90% 85%, rgba(160, 120, 70, 0.06) 0%, transparent 25%),
                radial-gradient(ellipse at 30% 70%, rgba(139, 90, 43, 0.05) 0%, transparent 20%),
                radial-gradient(ellipse at 70% 30%, rgba(160, 120, 70, 0.07) 0%, transparent 25%);
            pointer-events: none;
            z-index: 0;
        }

        .gear {
            position: fixed;
            color: rgba(139, 90, 43, 0.15);
            font-size: 120px;
            animation: rotate 20s linear infinite;
            pointer-events: none;
            z-index: 0;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }

        .gear1 { top: 5%; left: 3%; animation-duration: 25s; }
        .gear2 { top: 60%; right: 5%; font-size: 150px; animation-duration: 30s; animation-direction: reverse; }
        .gear3 { bottom: 10%; left: 8%; font-size: 90px; animation-duration: 20s; animation-direction: reverse; }
        .gear4 { top: 30%; right: 15%; font-size: 70px; animation-duration: 18s; }

        @keyframes rotate {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .container {
            max-width: 1400px;
            margin: 40px auto;
            background: linear-gradient(135deg, rgba(232, 212, 176, 0.95) 0%, rgba(217, 188, 140, 0.95) 100%);
            border: 6px solid #8b5a2b;
            box-shadow: 
                0 0 0 2px #654321,
                0 0 0 4px #8b5a2b,
                0 20px 50px rgba(0, 0, 0, 0.4),
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                inset 0 0 100px rgba(139, 90, 43, 0.08);
            padding: 50px 40px;
            position: relative;
            z-index: 1;
        }

        .rivet {
            position: absolute;
            width: 16px;
            height: 16px;
            background: radial-gradient(circle, #8b6914 0%, #5d4610 100%);
            border-radius: 50%;
            border: 2px solid #654321;
            box-shadow: inset 0 1px 2px rgba(0,0,0,0.6), 0 2px 4px rgba(0,0,0,0.3);
        }

        .rivet::before, .rivet::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 6px;
            height: 2px;
            background: #654321;
        }

        .rivet::before { transform: translate(-50%, -50%); }
        .rivet::after { transform: translate(-50%, -50%) rotate(90deg); }

        .rivet-tl { top: 25px; left: 25px; }
        .rivet-tr { top: 25px; right: 25px; }
        .rivet-bl { bottom: 25px; left: 25px; }
        .rivet-br { bottom: 25px; right: 25px; }

        .metal-strip {
            position: absolute;
            background: linear-gradient(90deg, #8b6914 0%, #b8860b 50%, #8b6914 100%);
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.3), inset 0 -1px 0 rgba(0, 0, 0, 0.5);
        }

        .metal-strip-top { top: 0; left: 0; right: 0; height: 6px; }
        .metal-strip-bottom { bottom: 0; left: 0; right: 0; height: 6px; }

        header {
            text-align: center;
            margin-bottom: 40px;
            padding-bottom: 30px;
            border-bottom: 4px solid #8b5a2b;
            box-shadow: 0 2px 0 rgba(139, 90, 43, 0.3);
        }

        h1 {
            font-family: 'IM Fell English', serif;
            font-size: 2.8em;
            color: #4a3020;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.2), 0 0 20px rgba(139, 90, 43, 0.2);
            font-style: italic;
            letter-spacing: 3px;
        }

        h1::before { content: '‚öô '; font-style: normal; color: #8b5a2b; }
        h1::after { content: ' ‚öô'; font-style: normal; color: #8b5a2b; }

        .subtitle {
            font-size: 1.1em;
            color: #6d4a2a;
            font-style: italic;
            margin-top: 10px;
        }

        h2 {
            font-family: 'IM Fell English', serif;
            color: #4a3020;
            font-size: 2em;
            margin-bottom: 20px;
            border-bottom: 3px solid #8b5a2b;
            padding-bottom: 10px;
        }

        h3 {
            font-family: 'IM Fell English', serif;
            color: #4a3020;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #8b5a2b;
            padding-bottom: 8px;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
        }

        .section {
            background: linear-gradient(135deg, rgba(255, 248, 230, 0.6) 0%, rgba(245, 235, 210, 0.6) 100%);
            border: 4px solid #8b5a2b;
            border-radius: 8px;
            padding: 20px;
            box-shadow: inset 0 2px 10px rgba(0, 0, 0, 0.1), 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .info-box {
            padding: 15px;
            background: rgba(139, 90, 43, 0.15);
            border: 2px solid #8b5a2b;
            border-radius: 6px;
            margin-bottom: 20px;
            color: #4a3020;
        }

        .info-box strong {
            color: #654321;
        }

        .info-box.success {
            background: rgba(76, 175, 80, 0.2);
            border: 2px solid #4caf50;
            color: #2e7d32;
        }

        .info-box.error {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            color: #c62828;
        }

        /* Dashboard */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 20px;
        }

        .dashboard-item {
            padding: 15px;
            background: linear-gradient(135deg, rgba(232, 212, 176, 0.8) 0%, rgba(217, 188, 140, 0.8) 100%);
            border: 3px solid #8b5a2b;
            border-radius: 8px;
            text-align: center;
        }

        .dashboard-item .label {
            font-weight: bold;
            color: #654321;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .dashboard-item .value {
            font-size: 28px;
            color: #4a3020;
            font-weight: bold;
        }

        .timer {
            color: #c62828 !important;
        }

        /* Componente in ispezione */
        .component-display {
            height: 300px;
            background: 
                repeating-linear-gradient(0deg, transparent 0px, transparent 49px, rgba(139, 90, 43, 0.1) 49px, rgba(139, 90, 43, 0.1) 50px),
                repeating-linear-gradient(90deg, transparent 0px, transparent 49px, rgba(139, 90, 43, 0.1) 49px, rgba(139, 90, 43, 0.1) 50px),
                linear-gradient(180deg, rgba(255, 250, 240, 0.9) 0%, rgba(250, 240, 220, 0.9) 100%);
            border: 2px solid #a0774a;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px 0;
            position: relative;
        }

        .component-icon {
            font-size: 120px;
            animation: gentle-pulse 3s ease-in-out infinite;
        }

        @keyframes gentle-pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .component-name {
            font-size: 1.5em;
            font-weight: bold;
            color: #4a3020;
            margin-top: 15px;
        }

        /* Specifiche */
        .specs-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin: 20px 0;
        }

        .spec-item {
            padding: 15px;
            background: rgba(255, 248, 230, 0.5);
            border: 2px solid #a0774a;
            border-radius: 6px;
        }

        .spec-item .label {
            font-weight: bold;
            color: #654321;
            margin-bottom: 5px;
            font-size: 12px;
        }

        .spec-item .value {
            font-size: 20px;
            color: #4a3020;
            font-weight: bold;
        }

        /* Calcoli */
        .calculation-input {
            margin: 20px 0;
        }

        .calculation-input label {
            display: block;
            margin-bottom: 10px;
            color: #4a3020;
            font-weight: bold;
        }

        .calculation-input input {
            width: 100%;
            padding: 12px;
            background: rgba(255, 248, 230, 0.8);
            border: 3px solid #8b5a2b;
            border-radius: 6px;
            color: #4a3020;
            font-family: 'Courier Prime', monospace;
            font-size: 16px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .calculation-input input:focus {
            outline: none;
            border-color: #d4a520;
            box-shadow: 
                inset 0 2px 5px rgba(0, 0, 0, 0.1),
                0 0 10px rgba(212, 165, 32, 0.3);
        }

        /* Pulsanti decisione */
        .decision-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        button {
            font-family: 'Special Elite', monospace;
            padding: 15px 20px;
            background: linear-gradient(180deg, #8b5a2b 0%, #654321 100%);
            color: #f4e4c1;
            border: 3px solid #654321;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.2),
                0 3px 8px rgba(0, 0, 0, 0.3);
            transition: all 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 
                inset 0 1px 0 rgba(255, 255, 255, 0.3),
                0 5px 12px rgba(0, 0, 0, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-accept {
            background: linear-gradient(180deg, #4caf50 0%, #2e7d32 100%);
            border-color: #2e7d32;
        }

        .btn-reject {
            background: linear-gradient(180deg, #f44336 0%, #c62828 100%);
            border-color: #c62828;
        }

        .btn-primary {
            background: linear-gradient(180deg, #d4a520 0%, #b8860b 100%);
            border-color: #b8860b;
            color: #4a3020;
        }

        /* Storico */
        .history-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 15px;
            background: rgba(255, 248, 230, 0.5);
            border: 2px solid #a0774a;
            border-radius: 6px;
        }

        .history-item {
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 6px;
            border: 2px solid;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .history-item.correct {
            background: rgba(76, 175, 80, 0.1);
            border-color: #4caf50;
        }

        .history-item.wrong {
            background: rgba(244, 67, 54, 0.1);
            border-color: #f44336;
        }

        .history-item .icon {
            font-size: 24px;
        }

        .history-item .details {
            flex: 1;
            margin-left: 10px;
        }

        .history-item .result {
            font-weight: bold;
        }

        /* Game over */
        .game-over {
            text-align: center;
            padding: 40px;
        }

        .game-over .final-score {
            font-size: 48px;
            color: #d4a520;
            font-weight: bold;
            margin: 20px 0;
        }

        @media (max-width: 1024px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: repeat(3, 1fr);
            }

            .specs-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 20px 15px;
                margin: 20px auto;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .gear {
                font-size: 80px;
            }

            .dashboard {
                grid-template-columns: 1fr;
            }

            .decision-buttons {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="gear gear1">‚öô</div>
    <div class="gear gear2">‚öô</div>
    <div class="gear gear3">‚öô</div>
    <div class="gear gear4">‚öô</div>
    
    <div class="container">
        <div class="rivet rivet-tl"></div>
        <div class="rivet rivet-tr"></div>
        <div class="rivet rivet-bl"></div>
        <div class="rivet rivet-br"></div>
        
        <div class="metal-strip metal-strip-top"></div>
        <div class="metal-strip metal-strip-bottom"></div>
        
        <header>
            <h1>La Fabbrica di Precisione</h1>
            <div class="subtitle">I.C. "C.Puddu", Corso di Fisica - prof. El Basri</div>
            <div class="subtitle">Controllo Qualit√† dei Componenti Meccanici</div>
        </header>

        <!-- Schermata iniziale -->
        <div id="start-screen">
            <div class="info-box" style="text-align: center; padding: 40px;">
                <h2 style="border: none; margin-bottom: 20px;">üè≠ Benvenuto Ispettore di Qualit√†!</h2>
                <p style="font-size: 1.1em; margin-bottom: 20px;">
                    La tua missione √® ispezionare <strong>10 componenti meccanici</strong> in arrivo dalla linea di produzione.<br>
                    Devi decidere se <strong>ACCETTARE</strong> o <strong>RIFIUTARE</strong> ogni componente basandoti sulla tolleranza consentita.
                </p>
                <p style="margin-bottom: 20px;">
                    <strong>Come funziona:</strong><br>
                    ‚Ä¢ Hai <strong>60 secondi per ogni componente</strong><br>
                    ‚Ä¢ Calcola l'errore percentuale: eR% = |Valore Misurato - Valore Nominale| / Valore Nominale √ó 100<br>
                    ‚Ä¢ <strong>Inserisci il valore calcolato</strong> nel campo apposito<br>
                    ‚Ä¢ Accetta se eR% ‚â§ tolleranza, altrimenti rifiuta<br>
                    ‚Ä¢ Se non inserisci nulla entro 60 secondi, conta come errore!
                </p>
                <button class="btn-primary" id="start-btn" style="font-size: 18px; padding: 20px 40px;">
                    üé¨ Inizia Turno di Lavoro
                </button>
            </div>
        </div>

        <!-- Schermata di gioco -->
        <div id="game-screen" style="display: none;">
            <!-- Dashboard -->
            <div class="dashboard">
                <div class="dashboard-item">
                    <div class="label">üì¶ Componente</div>
                    <div class="value"><span id="current-piece">1</span>/10</div>
                </div>
                <div class="dashboard-item">
                    <div class="label">‚è±Ô∏è Tempo Pezzo</div>
                    <div class="value timer" id="timer">60</div>
                </div>
                <div class="dashboard-item">
                    <div class="label">‚úì Corrette</div>
                    <div class="value" id="correct-count">0</div>
                </div>
            </div>

            <div class="main-content">
                <!-- Pannello sinistro: Ispezione -->
                <div class="section">
                    <h2>üîç Componente in Ispezione</h2>
                    
                    <div class="component-display">
                        <div class="component-icon" id="component-icon">‚öôÔ∏è</div>
                        <div class="component-name" id="component-name">Ingranaggio</div>
                    </div>

                    <h3>üìã Specifiche Tecniche:</h3>
                    <div class="specs-grid">
                        <div class="spec-item">
                            <div class="label">Valore Nominale</div>
                            <div class="value" id="nominal-value">10.00 cm</div>
                        </div>
                        <div class="spec-item">
                            <div class="label">Valore Misurato</div>
                            <div class="value" id="measured-value">10.15 cm</div>
                        </div>
                        <div class="spec-item" style="grid-column: 1 / -1;">
                            <div class="label">Tolleranza Massima Consentita</div>
                            <div class="value" id="tolerance-value">¬±2.0%</div>
                        </div>
                    </div>

                    <div class="calculation-input">
                        <label for="error-input">Calcola l'Errore Percentuale (eR%):</label>
                        <input type="number" id="error-input" step="0.01" placeholder="Inserisci il tuo calcolo...">
                        <div style="font-size: 0.85em; color: #6d4a2a; margin-top: 8px; font-style: italic;">
                            Formula: eR% = |Misurato - Nominale| / Nominale √ó 100
                        </div>
                    </div>

                    <div class="decision-buttons">
                        <button class="btn-accept" id="accept-btn">
                            ‚úì ACCETTA<br>
                            <small>Componente OK</small>
                        </button>
                        <button class="btn-reject" id="reject-btn">
                            ‚úó RIFIUTA<br>
                            <small>Fuori Tolleranza</small>
                        </button>
                    </div>

                    <div id="feedback-area"></div>
                </div>

                <!-- Pannello destro: Storico -->
                <div class="section">
                    <h2>üìä Storico Ispezioni</h2>
                    <div class="history-list" id="history-list">
                        <div class="info-box" style="text-align: center;">
                            Nessuna ispezione ancora effettuata
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Schermata finale -->
        <div id="end-screen" style="display: none;">
            <div class="game-over">
                <h2 style="font-size: 3em; border: none; margin-bottom: 20px;">‚úÖ Turno Completato!</h2>
                
                <div class="info-box" style="max-width: 600px; margin: 0 auto 30px;">
                    <div class="label" style="font-size: 1.2em; margin-bottom: 15px;">Punteggio Finale</div>
                    <div class="final-score" id="final-score">0</div>
                    <div style="font-size: 1.1em; margin-top: 15px;">
                        <strong id="final-correct">0</strong> corrette su 10 componenti
                    </div>
                    <div style="font-size: 1em; margin-top: 10px; color: #6d4a2a;">
                        ‚è±Ô∏è Tempo totale impiegato: <strong id="total-time">0</strong> secondi
                    </div>
                </div>

                <div id="performance-message"></div>

                <button class="btn-primary" id="restart-btn" style="font-size: 18px; padding: 20px 40px; margin-top: 30px;">
                    üîÑ Nuovo Turno di Lavoro
                </button>
            </div>
        </div>

        <!-- Pulsante Nuovo Esercizio -->
        <div id="new-exercise-section" style="margin-top: 40px; padding-top: 30px; border-top: 4px solid #8b5a2b; display: none;">
            <h3 style="font-family: 'IM Fell English', serif; color: #4a3020; text-align: center; margin-bottom: 20px;">
                üé≤ Nuovo Esercizio
            </h3>
            <div class="info-box" style="text-align: center;">
                Genera nuove tolleranze e componenti casuali per un nuovo esercizio!
            </div>
            <button class="btn-primary" id="new-exercise-btn" style="max-width: 500px; margin: 0 auto; display: block;">
                üîÑ Genera Nuovo Esercizio
            </button>
        </div>
    </div>

    <script>
        // Configurazione componenti
        const components = [
            { icon: '‚öôÔ∏è', name: 'Ingranaggio Piccolo', nominalRange: [3, 5] },
            { icon: '‚öôÔ∏è', name: 'Ingranaggio Medio', nominalRange: [10, 15] },
            { icon: '‚öôÔ∏è', name: 'Ingranaggio Grande', nominalRange: [25, 35] },
            { icon: '‚öôÔ∏è', name: 'Ruota Dentata', nominalRange: [55, 75] },
            { icon: 'ü™Ñ', name: 'Tubo di Metallo', nominalRange: [20, 30] },
            { icon: 'üìÄ', name: 'Valvola', nominalRange: [7, 12] },
            { icon: 'üî©', name: 'Bullone', nominalRange: [4, 6] },
            { icon: '„Ä∞Ô∏è', name: 'Molla', nominalRange: [12, 20] },
            { icon: 'ü´ô', name: 'Barattolo di Vetro', nominalRange: [35, 50] }
        ];

        const TOTAL_COMPONENTS = 10;
        const TIME_PER_COMPONENT = 60;

        let gameState = {
            isPlaying: false,
            currentPieceNumber: 1,
            timeLeft: TIME_PER_COMPONENT,
            correctCount: 0,
            wrongCount: 0,
            currentComponent: null,
            history: [],
            timerInterval: null,
            toleranceRange: [1, 5],
            totalTimeUsed: 0,
            startTime: null
        };

        // Elementi DOM
        const startScreen = document.getElementById('start-screen');
        const gameScreen = document.getElementById('game-screen');
        const endScreen = document.getElementById('end-screen');
        const startBtn = document.getElementById('start-btn');
        const restartBtn = document.getElementById('restart-btn');
        const acceptBtn = document.getElementById('accept-btn');
        const rejectBtn = document.getElementById('reject-btn');
        const errorInput = document.getElementById('error-input');
        const newExerciseBtn = document.getElementById('new-exercise-btn');
        const newExerciseSection = document.getElementById('new-exercise-section');

        // Inizia gioco
        startBtn.addEventListener('click', startGame);
        restartBtn.addEventListener('click', startGame);

        function startGame() {
            gameState = {
                isPlaying: true,
                currentPieceNumber: 1,
                timeLeft: TIME_PER_COMPONENT,
                correctCount: 0,
                wrongCount: 0,
                currentComponent: null,
                history: [],
                timerInterval: null,
                toleranceRange: gameState.toleranceRange,
                totalTimeUsed: 0,
                startTime: Date.now()
            };

            startScreen.style.display = 'none';
            gameScreen.style.display = 'block';
            endScreen.style.display = 'none';
            newExerciseSection.style.display = 'none';

            // Disabilita pulsanti all'inizio
            acceptBtn.disabled = true;
            rejectBtn.disabled = true;

            updateDashboard();
            generateNewComponent();
            startTimer();
        }

        // Timer
        function startTimer() {
            gameState.timerInterval = setInterval(() => {
                gameState.timeLeft--;
                document.getElementById('timer').textContent = gameState.timeLeft;

                if (gameState.timeLeft <= 0) {
                    // Timeout - conta come errore
                    handleTimeout();
                }
            }, 1000);
        }

        function stopTimer() {
            clearInterval(gameState.timerInterval);
        }

        function resetTimer() {
            gameState.timeLeft = TIME_PER_COMPONENT;
            document.getElementById('timer').textContent = gameState.timeLeft;
        }

        // Timeout
        function handleTimeout() {
            stopTimer();
            
            const comp = gameState.currentComponent;
            const actualError = Math.abs((comp.measured - comp.nominal) / comp.nominal * 100);
            
            gameState.wrongCount++;

            const feedbackArea = document.getElementById('feedback-area');
            feedbackArea.innerHTML = `<div class="info-box error" style="margin-top: 20px;">
                <strong>‚è∞ Tempo Scaduto!</strong><br>
                Non hai inserito un valore entro 60 secondi.<br>
                Errore percentuale corretto: ${actualError.toFixed(2)}%<br>
                Decisione corretta: ${comp.correctAnswer ? 'ACCETTARE' : 'RIFIUTARE'}
            </div>`;

            // Aggiungi allo storico
            gameState.history.unshift({
                component: comp,
                decision: null,
                correct: false,
                error: actualError,
                timeout: true
            });

            updateDashboard();
            updateHistory();

            // Prossimo componente
            setTimeout(() => {
                nextComponent();
            }, 2000);
        }

        // Abilita/disabilita pulsanti in base all'input
        errorInput.addEventListener('input', () => {
            const hasValue = errorInput.value.trim() !== '';
            acceptBtn.disabled = !hasValue;
            rejectBtn.disabled = !hasValue;
        });

        // Genera nuovo componente
        function generateNewComponent() {
            const component = components[Math.floor(Math.random() * components.length)];
            const [minNom, maxNom] = component.nominalRange;
            const nominal = Math.round((Math.random() * (maxNom - minNom) + minNom) * 10) / 10;
            
            const [minTol, maxTol] = gameState.toleranceRange;
            const tolerance = Math.round((Math.random() * (maxTol - minTol) + minTol) * 10) / 10;
            
            // Genera valore misurato
            const shouldBeAcceptable = Math.random() > 0.5;
            let measured;
            
            if (shouldBeAcceptable) {
                // Genera dentro tolleranza
                const maxError = (nominal * tolerance / 100) * 0.9;
                const error = (Math.random() - 0.5) * 2 * maxError;
                measured = nominal + error;
            } else {
                // Genera fuori tolleranza
                const minError = (nominal * tolerance / 100) * 1.2;
                const error = (Math.random() * 0.5 + minError) * (Math.random() > 0.5 ? 1 : -1);
                measured = nominal + error;
            }
            
            measured = Math.round(measured * 100) / 100;

            gameState.currentComponent = {
                icon: component.icon,
                name: component.name,
                nominal: nominal,
                measured: measured,
                tolerance: tolerance,
                correctAnswer: Math.abs((measured - nominal) / nominal * 100) <= tolerance
            };

            displayComponent();
            errorInput.value = '';
            acceptBtn.disabled = true;
            rejectBtn.disabled = true;
            document.getElementById('feedback-area').innerHTML = '';
        }

        // Visualizza componente
        function displayComponent() {
            const comp = gameState.currentComponent;
            document.getElementById('component-icon').textContent = comp.icon;
            document.getElementById('component-name').textContent = comp.name;
            document.getElementById('nominal-value').textContent = `${comp.nominal.toFixed(2)} cm`;
            document.getElementById('measured-value').textContent = `${comp.measured.toFixed(2)} cm`;
            document.getElementById('tolerance-value').textContent = `¬±${comp.tolerance.toFixed(1)}%`;
        }

        // Decisione
        acceptBtn.addEventListener('click', () => makeDecision(true));
        rejectBtn.addEventListener('click', () => makeDecision(false));

        function makeDecision(acceptDecision) {
            stopTimer();

            const comp = gameState.currentComponent;
            const actualError = Math.abs((comp.measured - comp.nominal) / comp.nominal * 100);
            const userError = parseFloat(errorInput.value);
            
            const isCorrect = acceptDecision === comp.correctAnswer;
            const errorCalculationCorrect = !isNaN(userError) && Math.abs(userError - actualError) < 0.1;

            if (isCorrect) {
                gameState.correctCount++;
            } else {
                gameState.wrongCount++;
            }

            // Feedback
            const feedbackArea = document.getElementById('feedback-area');
            let feedbackHTML = '';
            
            if (isCorrect) {
                feedbackHTML = `<div class="info-box success" style="margin-top: 20px;">
                    <strong>‚úì Decisione Corretta!</strong><br>
                    Errore percentuale: ${actualError.toFixed(2)}% ${comp.correctAnswer ? '‚â§' : '>'} ${comp.tolerance.toFixed(1)}%<br>
                    ${errorCalculationCorrect ? '‚úì Calcolo corretto! üéØ' : `‚ö†Ô∏è Calcolo errato: hai inserito ${userError.toFixed(2)}% (corretto: ${actualError.toFixed(2)}%)`}
                </div>`;
            } else {
                feedbackHTML = `<div class="info-box error" style="margin-top: 20px;">
                    <strong>‚úó Decisione Errata!</strong><br>
                    Errore percentuale: ${actualError.toFixed(2)}% ${comp.correctAnswer ? '‚â§' : '>'} ${comp.tolerance.toFixed(1)}%<br>
                    Dovevi ${comp.correctAnswer ? 'ACCETTARE' : 'RIFIUTARE'} il componente!<br>
                    ${errorCalculationCorrect ? 'Almeno il calcolo era corretto.' : `Calcolo errato: hai inserito ${userError.toFixed(2)}% (corretto: ${actualError.toFixed(2)}%)`}
                </div>`;
            }
            
            feedbackArea.innerHTML = feedbackHTML;

            // Aggiungi allo storico
            gameState.history.unshift({
                component: comp,
                decision: acceptDecision,
                correct: isCorrect,
                error: actualError,
                userError: userError,
                errorCalculationCorrect: errorCalculationCorrect,
                timeout: false
            });

            updateDashboard();
            updateHistory();

            // Prossimo componente
            setTimeout(() => {
                nextComponent();
            }, 2000);
        }

        // Prossimo componente
        function nextComponent() {
            if (gameState.currentPieceNumber >= TOTAL_COMPONENTS) {
                // Fine gioco
                endGame();
            } else {
                gameState.currentPieceNumber++;
                resetTimer();
                generateNewComponent();
                updateDashboard();
                startTimer();
            }
        }

        // Aggiorna dashboard
        function updateDashboard() {
            document.getElementById('current-piece').textContent = gameState.currentPieceNumber;
            document.getElementById('correct-count').textContent = gameState.correctCount;
        }

        // Aggiorna storico
        function updateHistory() {
            const historyList = document.getElementById('history-list');
            
            if (gameState.history.length === 0) {
                historyList.innerHTML = '<div class="info-box" style="text-align: center;">Nessuna ispezione ancora effettuata</div>';
                return;
            }

            historyList.innerHTML = gameState.history.map((item, index) => `
                <div class="history-item ${item.correct ? 'correct' : 'wrong'}">
                    <div class="icon">${item.component.icon}</div>
                    <div class="details">
                        <div><strong>#${TOTAL_COMPONENTS - index} - ${item.component.name}</strong></div>
                        <div style="font-size: 12px;">
                            ${item.timeout ? '‚è∞ Timeout' : `eR%: ${item.error.toFixed(2)}% | Tolleranza: ¬±${item.component.tolerance.toFixed(1)}%`}
                        </div>
                    </div>
                    <div class="result">${item.timeout ? '‚è∞' : item.correct ? '‚úì' : '‚úó'}</div>
                </div>
            `).join('');
        }

        // Fine gioco
        function endGame() {
            stopTimer();
            gameState.isPlaying = false;

            const totalTimeElapsed = Math.floor((Date.now() - gameState.startTime) / 1000);
            gameState.totalTimeUsed = totalTimeElapsed;

            const percentage = Math.round((gameState.correctCount / TOTAL_COMPONENTS) * 100);

            gameScreen.style.display = 'none';
            endScreen.style.display = 'block';
            newExerciseSection.style.display = 'block';

            document.getElementById('final-score').textContent = `${percentage}%`;
            document.getElementById('final-correct').textContent = gameState.correctCount;
            document.getElementById('total-time').textContent = totalTimeElapsed;

            let message = '';
            if (percentage === 100) {
                message = '<div class="info-box success"><strong>üèÜ PERFETTO!</strong><br>Hai ispezionato tutti i componenti correttamente! Sei un maestro del controllo qualit√†!</div>';
            } else if (percentage >= 80) {
                message = '<div class="info-box success"><strong>üëç Ottimo lavoro!</strong><br>Prestazione eccellente! La fabbrica √® in ottime mani.</div>';
            } else if (percentage >= 60) {
                message = '<div class="info-box"><strong>üìä Buon lavoro</strong><br>Discreto, ma puoi migliorare con pi√π pratica sui calcoli degli errori.</div>';
            } else {
                message = '<div class="info-box error"><strong>üìö Da rivedere</strong><br>Ripassa il calcolo dell\'errore percentuale e le tolleranze, poi riprova!</div>';
            }

            document.getElementById('performance-message').innerHTML = message;
        }

        // Nuovo esercizio
        newExerciseBtn.addEventListener('click', () => {
            // Genera nuova tolleranza casuale
            const minTol = Math.round((Math.random() * 1.5 + 0.5) * 10) / 10;
            const maxTol = Math.round((Math.random() * 3 + 2.5) * 10) / 10;
            
            gameState.toleranceRange = [minTol, maxTol];

            // Mostra messaggio
            const message = `
                <div class="info-box success" style="text-align: center; padding: 30px;">
                    <strong>‚úì Nuovo esercizio generato!</strong><br><br>
                    Nuova gamma di tolleranze: <strong>¬±${minTol.toFixed(1)}% - ¬±${maxTol.toFixed(1)}%</strong><br><br>
                    Clicca "Nuovo Turno di Lavoro" per iniziare!
                </div>
            `;

            endScreen.innerHTML = `
                <div class="game-over">
                    ${message}
                    <button class="btn-primary" id="restart-btn-new" style="font-size: 18px; padding: 20px 40px; margin-top: 30px;">
                        üîÑ Nuovo Turno di Lavoro
                    </button>
                </div>
            `;

            document.getElementById('restart-btn-new').addEventListener('click', startGame);
        });
    </script>
</body>
</html>
